{% if page.basemap %}
{% assign basemap = page.basemap %}
{% else %}
{% assign basemap = 'USGS Topo' %}
{% endif %}

{% assign mapid = include.map_id %}
{% assign zoom = include.zoom %}
{% assign align = include.align %}
{% assign height = include.height %}

<div class="simple-map align{{ align }} clearboth" style="height:{{ height }};">
  <div class="map" id="{{ page.id }}-{{ mapid }}"></div>
  <div id="google-map"></div>
</div>

<!-- Load common basemaps -->
<script src="/assets/data/basemaps.js"></script>
<script>

  const mapType = "{{ include.type }}";
  const map = L.map('{{ page.id }}-{{ mapid }}', { fullscreenControl: true, }).setView([40, -75], {{ zoom }});
  const geodataFile = "/assets/data/posts/geodata/{{ include.file }}";

  objBasemaps['{{ basemap }}'].addTo(map); // Assign default basemap

  L.control.polylineMeasure({ unit: 'landmiles', showBearings: true }).addTo(map);

  loadMapData(mapType, geodataFile);

  async function loadMapData(mapType, geodataFile) {
    let overlayLayer;
    switch (mapType) {
      case 'geojson': {
        const response = await fetch(geodataFile);
        if (!response.ok) throw new Error(response.statusText);

        const geojsonData = await response.json();

        overlayLayer = L.geoJson(geojsonData, {
          pointToLayer: function (feature, latlng) {
            const iconColor = "{{ include.icon_color }}";
            const iconNumber = feature.properties.number;

            const myIcon = L.divIcon({
              className: "number-icon-" + iconColor,
              iconSize: [25, 41],
              iconAnchor: [12, 46],
              popupAnchor: [3, -40],
              html: iconNumber
            });

            return L.marker(latlng, {
              icon: myIcon,
              riseOnHover: true
            }).setZIndexOffset(1000 - iconNumber);
          },

          onEachFeature: function (feature, layer) {
            layer.bindPopup(
              `<a href="${feature.properties.link_href}">
              <b>${feature.properties.name}</b>
             </a><br>${feature.properties.desc}`
            );
          }
        });

        overlayLayer.addTo(map);
        break;
      }
      case 'gpx': {
        overlayLayer = new L.GPX(geodataFile, {
          async: true,
          markers: {
            wptIconUrls: {
              '': '200px-Yellow_icon.svg.png',
              'Flag, Blue': 'blue-flag-32.png'
            },
            iconSize: [20, 20],
            iconAnchor: [0, 16],
            startIcon: null,
            endIcon: null
          },
          polyline_options: {
            color: "red"
          }
        }).addTo(map);

        // GPX loads asynchronously
        await new Promise(resolve => {
          overlayLayer.on('loaded', resolve);
        });

        break;
      }

      default:
        throw new Error('Invalid type');
    }

    L.control.layers(objBasemaps, { "POIs": overlayLayer }).addTo(map);

    if (overlayLayer.getBounds) {
      map.fitBounds(overlayLayer.getBounds().pad(0.3));
    }

    createGoogleMapLink(map);
  }

  function createGoogleMapLink(map) {
    const center = map.getBounds().getCenter();
    const googleMapLink = document.getElementById("google-map");
    googleMapLink.innerHTML = "<a href=https://www.google.com/maps/search/?api=1&query=" + center.lat + "," + center.lng + ">Google Map</a>";
  }

</script>