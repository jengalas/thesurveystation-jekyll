<div class="fullscreen-map-wrapper">
    <div id="recoveries-map" class="map"></div>
</div>
<link rel="stylesheet" href="/assets/js/plugins/mouseposition/L.Control.MousePosition.css">
<style>
    .leaflet-tooltip {
        font-size: 6px;
        padding: 1px;
    }
</style>
<script src="/assets/js/plugins/mouseposition/L.Control.MousePosition.js"></script>
<script src="/assets/data/pid-prefixes.js"></script>
<script>
$(document).ready(function(){
    var pidPrefixMap = L.map('recoveries-map', { fullscreenControl: true, geocoderControl: true }).setView([51.9, 7.9], 9);

    var lyrOSM;
    var lyrUSGSTopo;
    var lyrTopo;
    var lyrImagery;
    var lyrTopoQuads; 
    var lyrInfo;         
    var ctlAttribute;
    var ctlScale;
    var ctlMousePosition;
    var ctlLayers;
    var ctlInfo;
    var ctlSearch;
    var objOverlays; 

    var layers = {
        'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a target="_blank" href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(pidPrefixMap),
        'USGS Topo': L.tileLayer('https://caltopo.s3.amazonaws.com/topo/{z}/{x}/{y}.png', {
            attribution: 'USDA images from <a target="_blank" href="http://caltopo.com/">CalTopo</a>',
            maxZoom: 16,
            minZoom: 6
        }),
        'US National Map': L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 18,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }),
        'NatGeo': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; National Geographic, Esri, DeLorme, NAVTEQ, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPC',
            maxZoom: 16
        }),
        'Imagery (Clarity)': L.tileLayer('https://clarity.maptiles.arcgis.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        })
    };
    lyrTopoQuads = L.geoJSON(geojsonFeature, {
                weight: 2,                  
                onEachFeature: function (feature, layer) {
                    var popupText = '<b>'+feature.properties.PID+'</b>';     
                    layer.bindPopup(popupText);
                    var zoomLevel = pidPrefixMap.getZoom();
                    console.log(zoomLevel);
                    if (zoomLevel <=15 ) { //FIXME: figure out correct zoom levels to show and hide labels! https://stackoverflow.com/questions/41534115/how-change-icon-from-geojson-with-zoom-using-leaflet?
                    layer.bindTooltip(feature.properties.PID,
                        {permanent: true, direction:"center"});
                    } else {
                        layer.bindTooltip(feature.properties.PID,
                        {permanent: true, direction:"center"}).openTooltip();
                    }
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: clearFeature
                    });
                }
            }).addTo(pidPrefixMap);

            pidPrefixMap.fitBounds(lyrTopoQuads.getBounds());

            objOverlays = {
                "15' USGS Topo Quads": lyrTopoQuads
            };
            ctlLayers = L.control.layers(layers, objOverlays).addTo(pidPrefixMap);

            ctlAttribute = L.control.attribution({position: "bottomleft"}).addTo(pidPrefixMap);    
            ctlAttribute.addAttribution("&copy; <a target='_blank' href='https://thesurveystation.com'>Zhanna's SurveyStation</a>");

            ctlScale = L.control.scale({position: "bottomleft", metric: false, maxWidth: 200}).addTo(pidPrefixMap);

            ctlMousePosition = L.control.mousePosition().addTo(pidPrefixMap);

            var ctlInfo = L.control({position: "bottomright"});

            ctlInfo.onAdd = function (pidPrefixMap) {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                return this._div;
            };

            ctlInfo.update = function (props) {
                if (props != undefined) {
                    this._div.innerHTML = "<b>PID Prefix</b><br>" + props.PID;
                    this._div.style.padding = "10px 12px";
                }
                else {
                    this._div.innerHTML = "";
                    this._div.style.padding = "0";
                }
            };

            ctlInfo.addTo(pidPrefixMap);

            pidPrefixMap.on('mousemove', function(e){
                $("#mouse-location").html(LatLngToArrayString(e.latlng));
            });

            if (L.Browser.mobile) {
                pidPrefixMap.removeControl(pidPrefixMap.zoomControl);
                pidPrefixMap.removeControl(ctlInfo);
                pidPrefixMap.removeControl(ctlScale);
            }

            function highlightFeature(e) {
                layer = e.target;    
                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    layer.bringToFront();
                }    
                ctlInfo.update(layer.feature.properties);
            }

            function clearFeature(e) {
                layer = e.target;    
                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    layer.bringToFront();
                }    
                ctlInfo.update();
            }

            pidPrefixMap.on('zoomstart', function () {
                var zoomLevel = pidPrefixMap.getZoom();
                console.log(zoomLevel);
                var tooltip = $('.leaflet-tooltip');
                switch (zoomLevel) {
                    case 5:
                        tooltip.css('font-size', 9);
                        break;
                    case 1:
                        tooltip.css('font-size', 14);
                        break;
                    case 2:
                        tooltip.css('font-size', 16);
                        break;
                    case 3:
                        tooltip.css('font-size', 18);
                        break;
                    default:
                        tooltip.css('font-size', 14);
                }
            });


            function LatLngToArrayString(ll) {
            return "[" + ll.lat.toFixed(5) + ", " + ll.lng.toFixed(5) + "]";
            }
        });
</script>