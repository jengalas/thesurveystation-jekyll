<div class="fullscreen-map-wrapper">
  <div id="beacon-map" class="map"></div>
</div>

<!-- Load common basemaps -->
<script src="/assets/data/basemaps.js"></script>
<script>
  const beaconMap = L.map('beacon-map', { fullscreenControl: true, geocoderControl: true }).setView([39.8283, -98.5795], 9);

  objBasemaps['OpenStreetMap'].addTo(beaconMap); // Assign default basemap

  L.control.mapCenterCoord().addTo(beaconMap);

  const markerStyle = {
    radius: 5,
    fillOpacity: 1,
    stroke: true,
    color: "white",
    weight: 1,
    opacity: 1,
    fill: true,
    clickable: true
  };

  fetch('/assets/data/airway-beacons-complete-us.geojson')
    .then(res => res.json())
    .then(data => initMap(data))
    .catch(err => console.error('GeoJSON load error:', err));

  function initMap(geojson) {

    const categories = {};
    let Status;

    const allPoints = L.geoJson(geojson, {
      pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, markerStyle);
      },
      style: function (feature) {
        switch (feature.properties.Status) {
          case "Undetermined NGS beacon/arrow":
            return {
              fillColor: "gray"
            };
          case "Updated NGS beacon/arrow":
            return {
              fillColor: "red"
            };
          case "Updated non-NGS beacon/arrow":
            return {
              fillColor: "purple"
            };
        }
      },

      onEachFeature: function (feature, layer) {

        function hasValue(obj, key) {
          return obj &&
            Object.prototype.hasOwnProperty.call(obj, key) &&
            obj[key] !== null &&
            obj[key] !== "";
        }

        const props = feature.properties;
        let popupContent = "";

        if (hasValue(props, "PID")) {
          popupContent += `
      <b>PID:</b>
      <a href="https://www.ngs.noaa.gov/cgi-bin/ds_mark.prl?PidBox=${props.PID}" target="_blank">
        ${props.PID}
      </a><br/>
    `;
        }

        popupContent += `<b>Designation:</b> ${props.Designation}<br>`;

        popupContent += `
    <b>Coordinates:</b>
    ${feature.geometry.coordinates[1]},
    ${feature.geometry.coordinates[0]}<br>
  `;

        if (hasValue(props, "Report")) {
          popupContent += `<b>Status Report:</b> ${props.Report}`;
        }

        layer.bindPopup(popupContent);
        Status = feature.properties.Status;
        // Initialize the category array if not already set.
        if (typeof categories[Status] === "undefined") {
          categories[Status] = [];
        }
        categories[Status].push(layer);
      }
    });

    // Feature layers for control	
    const overlaysObj = {};

    Object.entries(categories).forEach(([statusName, layers]) => {
      overlaysObj[statusName] = L.layerGroup(layers).addTo(beaconMap);
    });

    const control = L.control.layers(objBasemaps, overlaysObj, {
      collapsed: true
    }).addTo(beaconMap);

    beaconMap.on("overlayadd overlayremove", updateCounter);

    // ---- Insert Counter Inside Overlay Section ----

    const overlaysContainer =
      control.getContainer().querySelector(".leaflet-control-layers-overlays");

    const counterNode = document.createElement("div");
    counterNode.id = "counterValue";
    counterNode.style.padding = "6px 0 0 0";
    counterNode.style.fontWeight = "bold";

    overlaysContainer.appendChild(counterNode);

    // Compute visible markers
    function updateCounter() {
      let total = 0;

      Object.values(overlaysObj).forEach(layerGroup => {
        if (beaconMap.hasLayer(layerGroup)) {
          total += layerGroup.getLayers().length;
        }
      });

      counterNode.textContent = `${total} beacons/arrows`;
    }

    // Initial count
    updateCounter();

    // Update when toggling overlays
    beaconMap.on("overlayadd overlayremove", updateCounter);

    beaconMap.fitBounds(allPoints.getBounds());

    const textSearch = L.control.search({
      layer: allPoints,
      initial: false,
      zoom: 9,
      marker: { animate: false, circle: false, icon: false },
      textPlaceholder: 'Search by PID ...',
      propertyName: 'PID'
    }).addTo(beaconMap);

    textSearch.on('search:locationfound', function (event) {
      event.layer.openPopup();
    });

    document.addEventListener("DOMContentLoaded", () => {
      // ---- Beacon Counter ----

      control.getContainer().appendChild(counterNode);

      // Helper function to compute total visible markers
      function updateCounter() {
        let total = 0;

        Object.values(overlaysObj).forEach(layerGroup => {
          if (beaconMap.hasLayer(layerGroup)) {
            total += layerGroup.getLayers().length;
          }
        });

        counterNode.textContent = `${total} beacons/arrows`;
      }

      // Initialize counter
      updateCounter();

      // Update when overlays change
      beaconMap.on("overlayadd overlayremove", updateCounter);
    });
  };
</script>